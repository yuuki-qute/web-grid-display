<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方眼グリッドアプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .grid-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .grid-canvas {
            width: 100%;
            height: 100%;
        }

        .control-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-2px);
        }

        .fullscreen-button {
            right: 20px;
        }

        .settings-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            max-width: 400px;
            width: 350px;
            max-height: calc(100vh - 90px);
            overflow-y: auto;
            display: none;
            cursor: move;
            user-select: none;
            border: 1px solid #ddd;
        }

        .settings-popup.show {
            display: block;
            animation: fadeInSlide 0.3s ease;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-popup.dragging {
            pointer-events: none;
        }

        .settings-popup.dragging * {
            pointer-events: none;
        }

        .popup-overlay {
            /* オーバーレイを削除してモードレスにする */
            display: none !important;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 16px;
            cursor: move;
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        .close-button:hover {
            background: #f0f0f0;
            color: #333;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007AFF;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #007AFF;
        }

        .radio-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin: 0;
        }

        /* プリセット用のボタン風ラジオボタンスタイル */
        .preset-radio-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .preset-radio-item {
            position: relative;
        }

        .preset-radio-item input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .preset-radio-item label {
            display: inline-block;
            padding: 8px 16px;
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            min-width: 40px;
            transition: all 0.2s ease;
            user-select: none;
        }

        .preset-radio-item label:hover {
            background: #e8e8e8;
            border-color: #bbb;
            transform: translateY(-1px);
        }

        .preset-radio-item input[type="radio"]:checked + label {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .preset-radio-item input[type="radio"]:focus + label {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .divider {
            height: 1px;
            background: #eee;
            margin: 20px 0;
        }

        .color-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .color-label {
            font-size: 12px;
            color: #666;
        }

        .markers-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .marker {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
        }

        .reset-button {
            width: 100%;
            padding: 12px 16px;
            background: #666666;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reset-button:hover {
            background: #555555;
            transform: translateY(-1px);
        }

        .reset-button:active {
            transform: translateY(0);
        }

        /* プリセットボタン風ラジオボタン */
        .preset-radio-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .preset-radio-item {
            position: relative;
        }

        .preset-radio-item input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .preset-radio-item label {
            display: inline-block;
            padding: 10px 16px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #666;
            transition: all 0.2s ease;
            min-width: 40px;
            text-align: center;
            user-select: none;
        }

        .preset-radio-item label:hover {
            background: #e8e8e8;
            border-color: #bbb;
            color: #444;
        }

        .preset-radio-item input[type="radio"]:checked + label {
            background: #007AFF;
            border-color: #007AFF;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .preset-radio-item input[type="radio"]:focus + label {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }

        /* 言語切替ドロップダウン */
        .language-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .language-selector select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="grid-container">
        <canvas class="grid-canvas" id="gridCanvas"></canvas>
    </div>
    
    <div class="markers-container" id="markersContainer"></div>

    <button class="control-button settings-button" id="settingsButton">⚙️ 設定</button>
    <button class="control-button fullscreen-button" id="fullscreenButton">⛶ 全画面</button>

    <div class="language-selector">
        <select id="languageSelector">
            <option value="en">🇺🇸 English</option>
            <option value="ja">🇯🇵 日本語</option>
        </select>
    </div>

    <div class="popup-overlay" id="popupOverlay"></div>
    
    <div class="settings-popup" id="settingsPopup">
        <div class="settings-header">
            <h2 class="settings-title">グリッド設定</h2>
            <button class="close-button" id="closeButton">&times;</button>
        </div>

        <div class="setting-group" id="presetsGroup">
            <label class="setting-label" id="presetsLabel">プリセット</label>
            <div class="preset-radio-group">
                <div class="preset-radio-item">
                    <input type="radio" id="preset1" name="preset" value="1" checked>
                    <label for="preset1">1</label>
                </div>
                <div class="preset-radio-item">
                    <input type="radio" id="preset2" name="preset" value="2">
                    <label for="preset2">2</label>
                </div>
                <div class="preset-radio-item">
                    <input type="radio" id="preset3" name="preset" value="3">
                    <label for="preset3">3</label>
                </div>
                <div class="preset-radio-item">
                    <input type="radio" id="preset4" name="preset" value="4">
                    <label for="preset4">4</label>
                </div>
                <div class="preset-radio-item">
                    <input type="radio" id="preset5" name="preset" value="5">
                    <label for="preset5">5</label>
                </div>
                <div class="preset-radio-item">
                    <input type="radio" id="preset6" name="preset" value="6">
                    <label for="preset6">6</label>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="setting-group" id="gridTypeGroup">
            <label class="setting-label" id="gridTypeLabel">グリッド種類</label>
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="gridTypeLines" name="gridType" value="lines" checked>
                    <label for="gridTypeLines">罫線</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="gridTypeDots" name="gridType" value="dots">
                    <label for="gridTypeDots">ドット</label>
                </div>
            </div>
        </div>

        <div class="setting-group" id="gridSpacingGroup">
            <label class="setting-label" id="gridSpacingLabel">グリッド間隔 (px)</label>
            <div class="input-group">
                <input type="range" id="gridSpacing" min="8" max="64" value="20">
                <input type="number" id="gridSpacingNumber" min="8" max="64" value="20">
            </div>
        </div>

        <div class="setting-group" id="rotationGroup">
            <label class="setting-label" id="rotationLabel">回転角度 (度)</label>
            <div class="input-group">
                <input type="range" id="gridRotation" min="0" max="180" value="0">
                <input type="number" id="gridRotationNumber" min="0" max="180" value="0">
            </div>
        </div>

        <div class="divider"></div>

        <div class="setting-group" id="colorSettingsGroup">
            <label class="setting-label" id="colorSettingsLabel">色設定</label>
            <div class="color-group">
                <div class="color-item">
                    <input type="color" id="backgroundColor" value="#ffffff">
                    <span class="color-label">背景色</span>
                </div>
                <div class="color-item">
                    <input type="color" id="gridColor" value="#cccccc">
                    <span class="color-label">グリッド</span>
                </div>
                <div class="color-item">
                    <input type="color" id="markerColor" value="#ff0000">
                    <span class="color-label">中央目印</span>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="setting-group" id="showMarkersGroup">
            <div class="checkbox-group">
                <input type="checkbox" id="showMarkers">
                <label class="setting-label" id="showMarkersLabel" for="showMarkers">中央目印を表示</label>
            </div>
        </div>

        <div class="setting-group" id="markerSizeGroup">
            <label class="setting-label" id="markerSizeLabel">目印サイズ (px)</label>
            <div class="input-group">
                <input type="range" id="markerSize" min="4" max="32" value="12">
                <input type="number" id="markerSizeNumber" min="4" max="32" value="12">
            </div>
        </div>

        <div class="divider"></div>

        <div class="setting-group" id="emphasizeGridGroup">
            <div class="checkbox-group">
                <input type="checkbox" id="emphasizeGrid">
                <label class="setting-label" id="emphasizeGridLabel" for="emphasizeGrid">グリッド強調</label>
            </div>
        </div>

        <div class="setting-group" id="emphasizeIntervalGroup">
            <label class="setting-label" id="emphasizeIntervalLabel">強調間隔 (グリッド数)</label>
            <div class="input-group">
                <input type="range" id="emphasizeInterval" min="2" max="10" value="5">
                <input type="number" id="emphasizeIntervalNumber" min="2" max="10" value="5">
            </div>
        </div>

        <div class="setting-group" id="emphasizeStrengthGroup">
            <label class="setting-label" id="emphasizeStrengthLabel">強調度合い</label>
            <div class="input-group">
                <input type="range" id="emphasizeStrength" min="1" max="5" value="2">
                <input type="number" id="emphasizeStrengthNumber" min="1" max="5" value="2">
            </div>
        </div>

        <div class="divider"></div>

        <div class="setting-group">
            <button class="reset-button" id="resetButton">デフォルトに戻す</button>
        </div>
    </div>

    <script>
        class GridApp {
            constructor() {
                this.canvas = document.getElementById('gridCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.markersContainer = document.getElementById('markersContainer');
                
                // Current preset number (1-6)
                this.currentPreset = 1;
                
                // Current language - ブラウザの言語設定を取得してデフォルト言語を決定
                this.currentLanguage = this.detectBrowserLanguage();
                
                // Language translations
                this.translations = {
                    en: {
                        settingsTitle: 'Grid Settings',
                        presets: 'Presets',
                        gridType: 'Grid Type',
                        lines: 'Lines',
                        dots: 'Dots',
                        gridSpacing: 'Grid Spacing (px)',
                        rotation: 'Rotation (degrees)',
                        colorSettings: 'Color Settings',
                        backgroundColor: 'Background',
                        gridColor: 'Grid',
                        markerColor: 'Center Mark',
                        showMarkers: 'Show Center Markers',
                        markerSize: 'Marker Size (px)',
                        emphasizeGrid: 'Emphasize Grid',
                        emphasizeInterval: 'Emphasis Interval (grids)',
                        emphasizeStrength: 'Emphasis Strength',
                        resetButton: 'Reset to Default',
                        resetConfirm: 'Reset settings to default?',
                        settingsButton: '⚙️ Settings',
                        fullscreenButton: '⛶ Fullscreen',
                        fullscreenExit: '🔳 Exit Fullscreen'
                    },
                    ja: {
                        settingsTitle: 'グリッド設定',
                        presets: 'プリセット',
                        gridType: 'グリッド種類',
                        lines: '罫線',
                        dots: 'ドット',
                        gridSpacing: 'グリッド間隔 (px)',
                        rotation: '回転角度 (度)',
                        colorSettings: '色設定',
                        backgroundColor: '背景色',
                        gridColor: 'グリッド',
                        markerColor: '中央目印',
                        showMarkers: '中央目印を表示',
                        markerSize: '目印サイズ (px)',
                        emphasizeGrid: 'グリッド強調',
                        emphasizeInterval: '強調間隔 (グリッド数)',
                        emphasizeStrength: '強調度合い',
                        resetButton: 'デフォルトに戻す',
                        resetConfirm: '設定をデフォルトに戻しますか？',
                        settingsButton: '⚙️ 設定',
                        fullscreenButton: '⛶ 全画面',
                        fullscreenExit: '🔳 全画面終了'
                    }
                };
                
                // Default settings
                this.defaultSettings = {
                    gridType: 'lines',
                    spacing: 20,
                    backgroundColor: '#ffffff',
                    gridColor: '#cccccc',
                    showMarkers: true,
                    markerSize: 12,
                    markerColor: '#ff0000',
                    emphasizeGrid: false,
                    emphasizeInterval: 5,
                    emphasizeStrength: 2,
                    gridRotation: 0
                };

                // Load current preset and settings
                this.loadCurrentPreset();
                this.loadCurrentLanguage();
                this.settings = this.loadSettings();

                this.initializeElements();
                this.setupEventListeners();
                this.setupDragFunctionality(); // ドラッグ機能を追加
                this.applySettingsToUI();
                this.updateUI(); // 言語に応じたUIを初期化
                this.resizeCanvas();
                this.drawGrid();
                this.updateMarkers(); // 保存された目印設定を適用
                
                // 初期表示時にボタン位置を調整
                setTimeout(() => this.adjustSettingsButtonPosition(), 100);
                
                // 起動時に設定ウィンドウを表示
                this.showSettings();
                
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
                
                // 全画面モードの変更を監視
                document.addEventListener('fullscreenchange', () => {
                    // 全画面切替後に少し遅延させて描画を更新
                    setTimeout(() => {
                        this.handleResize();
                    }, 200);
                });
                
                // DPRの変更を監視（ディスプレイ間の移動など）
                const mediaQuery = window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);
                mediaQuery.addEventListener('change', () => {
                    this.handleResize();
                });
            }

            detectBrowserLanguage() {
                // ブラウザの言語設定を取得
                const browserLang = navigator.language || navigator.userLanguage || 'en';
                
                // 日本語（ja, ja-JP など）の場合は日本語を、そうでなければ英語を返す
                if (browserLang.toLowerCase().startsWith('ja')) {
                    return 'ja';
                } else {
                    return 'en';
                }
            }

            loadCurrentPreset() {
                try {
                    const saved = localStorage.getItem('gridAppCurrentPreset');
                    if (saved) {
                        this.currentPreset = parseInt(saved);
                        if (this.currentPreset < 1 || this.currentPreset > 6) {
                            this.currentPreset = 1;
                        }
                    }
                } catch (error) {
                    console.warn('プリセット番号の読み込みに失敗しました:', error);
                    this.currentPreset = 1;
                }
            }

            saveCurrentPreset() {
                try {
                    localStorage.setItem('gridAppCurrentPreset', this.currentPreset.toString());
                } catch (error) {
                    console.warn('プリセット番号の保存に失敗しました:', error);
                }
            }

            loadCurrentLanguage() {
                try {
                    const saved = localStorage.getItem('gridAppCurrentLanguage');
                    if (saved && this.translations[saved]) {
                        this.currentLanguage = saved;
                    } else {
                        // 保存された言語設定がない場合、ブラウザの言語を使用
                        this.currentLanguage = this.detectBrowserLanguage();
                    }
                } catch (error) {
                    console.warn('言語設定の読み込みに失敗しました:', error);
                    this.currentLanguage = this.detectBrowserLanguage();
                }
            }

            saveCurrentLanguage() {
                try {
                    localStorage.setItem('gridAppCurrentLanguage', this.currentLanguage);
                } catch (error) {
                    console.warn('言語設定の保存に失敗しました:', error);
                }
            }

            switchLanguage(language) {
                if (!this.translations[language]) return;
                
                this.currentLanguage = language;
                this.saveCurrentLanguage();
                this.updateUI();
            }

            getText(key) {
                return this.translations[this.currentLanguage][key] || this.translations.en[key] || key;
            }

            updateUI() {
                // ボタンテキストを更新
                this.settingsButton.textContent = this.getText('settingsButton');
                
                // 全画面ボタンのテキストを現在の状態に応じて更新
                if (document.fullscreenElement) {
                    this.fullscreenButton.textContent = this.getText('fullscreenExit');
                } else {
                    this.fullscreenButton.textContent = this.getText('fullscreenButton');
                }
                
                // 設定ポップアップのテキストを更新
                this.updateSettingsPopupTexts();
                
                // 言語セレクターの値を更新
                const languageSelector = document.getElementById('languageSelector');
                if (languageSelector) {
                    languageSelector.value = this.currentLanguage;
                }
                
                // ボタンのレイアウトを再調整
                setTimeout(() => {
                    this.adjustSettingsButtonPosition();
                }, 50);
            }

            updateSettingsPopupTexts() {
                // 設定ポップアップ内のテキストを更新
                const settingsTitle = this.settingsPopup.querySelector('.settings-title');
                if (settingsTitle) {
                    settingsTitle.textContent = this.getText('settingsTitle');
                }
                
                // 各ラベルをIDベースで更新
                const labelElements = [
                    { id: 'presetsLabel', key: 'presets' },
                    { id: 'gridTypeLabel', key: 'gridType' },
                    { id: 'gridSpacingLabel', key: 'gridSpacing' },
                    { id: 'rotationLabel', key: 'rotation' },
                    { id: 'colorSettingsLabel', key: 'colorSettings' },
                    { id: 'showMarkersLabel', key: 'showMarkers' },
                    { id: 'markerSizeLabel', key: 'markerSize' },
                    { id: 'emphasizeGridLabel', key: 'emphasizeGrid' },
                    { id: 'emphasizeIntervalLabel', key: 'emphasizeInterval' },
                    { id: 'emphasizeStrengthLabel', key: 'emphasizeStrength' }
                ];
                
                labelElements.forEach(({ id, key }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = this.getText(key);
                    }
                });
                
                // ラジオボタンのラベルを更新
                const gridTypeLinesLabel = this.settingsPopup.querySelector('label[for="gridTypeLines"]');
                const gridTypeDotsLabel = this.settingsPopup.querySelector('label[for="gridTypeDots"]');
                if (gridTypeLinesLabel) gridTypeLinesLabel.textContent = this.getText('lines');
                if (gridTypeDotsLabel) gridTypeDotsLabel.textContent = this.getText('dots');
                
                // 色設定のラベルを更新
                const colorLabels = this.settingsPopup.querySelectorAll('.color-label');
                if (colorLabels.length >= 3) {
                    colorLabels[0].textContent = this.getText('backgroundColor');
                    colorLabels[1].textContent = this.getText('gridColor');
                    colorLabels[2].textContent = this.getText('markerColor');
                }
                
                // リセットボタンを更新
                const resetButton = this.settingsPopup.querySelector('.reset-button');
                if (resetButton) {
                    resetButton.textContent = this.getText('resetButton');
                }
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem(`gridAppSettings_preset${this.currentPreset}`);
                    if (saved) {
                        const parsedSettings = JSON.parse(saved);
                        // デフォルト設定とマージして、新しい設定項目も対応
                        return { ...this.defaultSettings, ...parsedSettings };
                    }
                } catch (error) {
                    console.warn('設定の読み込みに失敗しました:', error);
                }
                return { ...this.defaultSettings };
            }

            saveSettings() {
                try {
                    localStorage.setItem(`gridAppSettings_preset${this.currentPreset}`, JSON.stringify(this.settings));
                } catch (error) {
                    console.warn('設定の保存に失敗しました:', error);
                }
            }

            switchPreset(presetNumber) {
                // 現在の設定を保存
                this.saveSettings();
                
                // プリセット番号を変更
                this.currentPreset = presetNumber;
                this.saveCurrentPreset();
                
                // 新しいプリセットの設定を読み込み
                this.settings = this.loadSettings();
                
                // UIに反映
                this.applySettingsToUI();
                this.drawGrid();
                this.updateMarkers();
                document.body.style.backgroundColor = this.settings.backgroundColor;
            }

            resetSettings() {
                this.settings = { ...this.defaultSettings };
                this.saveSettings();
                this.applySettingsToUI();
                this.drawGrid();
                this.updateMarkers();
                document.body.style.backgroundColor = this.settings.backgroundColor;
            }

            applySettingsToUI() {
                // プリセット選択を反映
                const presetRadio = document.getElementById(`preset${this.currentPreset}`);
                if (presetRadio) {
                    presetRadio.checked = true;
                }
                
                // UI要素に設定値を適用
                if (this.settings.gridType === 'lines') {
                    this.gridTypeLinesRadio.checked = true;
                } else {
                    this.gridTypeDotsRadio.checked = true;
                }
                this.gridSpacingRange.value = this.settings.spacing;
                this.gridSpacingNumber.value = this.settings.spacing;
                this.backgroundColorInput.value = this.settings.backgroundColor;
                this.gridColorInput.value = this.settings.gridColor;
                this.markerColorInput.value = this.settings.markerColor;
                this.showMarkersCheckbox.checked = this.settings.showMarkers;
                this.markerSizeRange.value = this.settings.markerSize;
                this.markerSizeNumber.value = this.settings.markerSize;
                this.emphasizeGridCheckbox.checked = this.settings.emphasizeGrid;
                this.emphasizeIntervalRange.value = this.settings.emphasizeInterval;
                this.emphasizeIntervalNumber.value = this.settings.emphasizeInterval;
                this.emphasizeStrengthRange.value = this.settings.emphasizeStrength;
                this.emphasizeStrengthNumber.value = this.settings.emphasizeStrength;
                this.gridRotationRange.value = this.settings.gridRotation;
                this.gridRotationNumber.value = this.settings.gridRotation;
                
                // 背景色も適用
                document.body.style.backgroundColor = this.settings.backgroundColor;
            }

            setupDragFunctionality() {
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };

                const startDrag = (e) => {
                    // クローズボタンがクリックされた場合はドラッグを開始しない
                    if (e.target.classList.contains('close-button') || 
                        e.target.closest('.close-button')) {
                        return;
                    }
                    
                    // タッチイベントとマウスイベントの両方に対応
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    isDragging = true;
                    this.settingsPopup.classList.add('dragging');
                    
                    const rect = this.settingsPopup.getBoundingClientRect();
                    dragOffset.x = clientX - rect.left;
                    dragOffset.y = clientY - rect.top;
                    
                    e.preventDefault();
                };

                const drag = (e) => {
                    if (!isDragging) return;
                    
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    let newX = clientX - dragOffset.x;
                    let newY = clientY - dragOffset.y;
                    
                    // 画面境界内に制限
                    const maxX = window.innerWidth - this.settingsPopup.offsetWidth;
                    const maxY = window.innerHeight - this.settingsPopup.offsetHeight;
                    
                    newX = Math.max(0, Math.min(maxX, newX));
                    newY = Math.max(0, Math.min(maxY, newY));
                    
                    this.settingsPopup.style.left = newX + 'px';
                    this.settingsPopup.style.top = newY + 'px';
                    
                    e.preventDefault();
                };

                const endDrag = () => {
                    isDragging = false;
                    this.settingsPopup.classList.remove('dragging');
                };

                // ヘッダー部分でドラッグ開始
                this.settingsHeader = this.settingsPopup.querySelector('.settings-header');
                
                // マウスイベント
                this.settingsHeader.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
                
                // タッチイベント
                this.settingsHeader.addEventListener('touchstart', startDrag, { passive: false });
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('touchend', endDrag);
            }

            handleResize() {
                // 複数回呼ばれることを防ぐためのデバウンス処理
                if (this.resizeTimeout) {
                    clearTimeout(this.resizeTimeout);
                }
                
                this.resizeTimeout = setTimeout(() => {
                    // 強制的にキャンバスサイズを再計算
                    this.canvas.style.width = '';
                    this.canvas.style.height = '';
                    
                    // 設定ウィンドウの位置を調整
                    this.adjustSettingsPopupPosition();
                    
                    // 次のフレームで処理を実行
                    requestAnimationFrame(() => {
                        this.resizeCanvas();
                        this.drawGrid();
                        this.updateMarkers();
                    });
                }, 100);
            }

            adjustSettingsPopupPosition() {
                // 設定ウィンドウが表示されていない場合は何もしない
                if (!this.settingsPopup.classList.contains('show')) {
                    return;
                }
                
                const popup = this.settingsPopup;
                const rect = popup.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                let newLeft = rect.left;
                let newTop = rect.top;
                let moved = false;
                
                // 右端がはみ出している場合
                if (rect.right > windowWidth) {
                    newLeft = windowWidth - rect.width - 20; // 右端から20pxのマージン
                    moved = true;
                }
                
                // 左端がはみ出している場合
                if (newLeft < 0) {
                    newLeft = 20; // 左端から20pxのマージン
                    moved = true;
                }
                
                // 下端がはみ出している場合
                if (rect.bottom > windowHeight) {
                    newTop = windowHeight - rect.height - 20; // 下端から20pxのマージン
                    moved = true;
                }
                
                // 上端がはみ出している場合
                if (newTop < 0) {
                    newTop = 20; // 上端から20pxのマージン
                    moved = true;
                }
                
                // 位置が変更された場合のみスタイルを更新
                if (moved) {
                    popup.style.left = newLeft + 'px';
                    popup.style.top = newTop + 'px';
                    popup.style.right = 'auto'; // rightプロパティをリセット
                }
            }

            initializeElements() {
                this.settingsButton = document.getElementById('settingsButton');
                this.fullscreenButton = document.getElementById('fullscreenButton');
                this.settingsPopup = document.getElementById('settingsPopup');
                this.popupOverlay = document.getElementById('popupOverlay');
                this.closeButton = document.getElementById('closeButton');
                this.languageSelector = document.getElementById('languageSelector');

                // Preset elements
                this.preset1Radio = document.getElementById('preset1');
                this.preset2Radio = document.getElementById('preset2');
                this.preset3Radio = document.getElementById('preset3');
                this.preset4Radio = document.getElementById('preset4');
                this.preset5Radio = document.getElementById('preset5');
                this.preset6Radio = document.getElementById('preset6');

                // Input elements
                this.gridTypeLinesRadio = document.getElementById('gridTypeLines');
                this.gridTypeDotsRadio = document.getElementById('gridTypeDots');
                this.gridSpacingRange = document.getElementById('gridSpacing');
                this.gridSpacingNumber = document.getElementById('gridSpacingNumber');
                this.backgroundColorInput = document.getElementById('backgroundColor');
                this.gridColorInput = document.getElementById('gridColor');
                this.markerColorInput = document.getElementById('markerColor');
                this.showMarkersCheckbox = document.getElementById('showMarkers');
                this.markerSizeRange = document.getElementById('markerSize');
                this.markerSizeNumber = document.getElementById('markerSizeNumber');
                this.emphasizeGridCheckbox = document.getElementById('emphasizeGrid');
                this.emphasizeIntervalRange = document.getElementById('emphasizeInterval');
                this.emphasizeIntervalNumber = document.getElementById('emphasizeIntervalNumber');
                this.emphasizeStrengthRange = document.getElementById('emphasizeStrength');
                this.emphasizeStrengthNumber = document.getElementById('emphasizeStrengthNumber');
                this.gridRotationRange = document.getElementById('gridRotation');
                this.gridRotationNumber = document.getElementById('gridRotationNumber');
                this.resetButton = document.getElementById('resetButton');
            }

            setupEventListeners() {
                // Settings popup
                this.settingsButton.addEventListener('click', () => this.toggleSettings());
                
                // クローズボタンのイベントリスナーを最初に設定（優先度を高くする）
                this.closeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    this.hideSettings();
                });
                
                // クローズボタンでのドラッグを防ぐ
                this.closeButton.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                
                this.closeButton.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                });

                // Fullscreen
                this.fullscreenButton.addEventListener('click', () => this.toggleFullscreen());

                // Language selector
                this.languageSelector.addEventListener('change', (e) => {
                    this.switchLanguage(e.target.value);
                });

                // Preset selection
                this.preset1Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(1);
                });
                this.preset2Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(2);
                });
                this.preset3Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(3);
                });
                this.preset4Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(4);
                });
                this.preset5Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(5);
                });
                this.preset6Radio.addEventListener('change', (e) => {
                    if (e.target.checked) this.switchPreset(6);
                });

                // Settings inputs
                this.gridTypeLinesRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.settings.gridType = 'lines';
                        this.saveSettings();
                        this.drawGrid();
                    }
                });

                this.gridTypeDotsRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.settings.gridType = 'dots';
                        this.saveSettings();
                        this.drawGrid();
                    }
                });

                // Grid spacing sync
                this.gridSpacingRange.addEventListener('input', (e) => {
                    this.settings.spacing = parseInt(e.target.value);
                    this.gridSpacingNumber.value = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                    this.updateMarkers();
                });

                this.gridSpacingNumber.addEventListener('input', (e) => {
                    const value = Math.min(64, Math.max(8, parseInt(e.target.value) || 8));
                    this.settings.spacing = value;
                    this.gridSpacingRange.value = value;
                    e.target.value = value;
                    this.saveSettings();
                    this.drawGrid();
                    this.updateMarkers();
                });

                // Colors
                this.backgroundColorInput.addEventListener('change', (e) => {
                    this.settings.backgroundColor = e.target.value;
                    document.body.style.backgroundColor = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                });

                this.gridColorInput.addEventListener('change', (e) => {
                    this.settings.gridColor = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                });

                this.markerColorInput.addEventListener('change', (e) => {
                    this.settings.markerColor = e.target.value;
                    this.saveSettings();
                    this.updateMarkers();
                });

                // Markers
                this.showMarkersCheckbox.addEventListener('change', (e) => {
                    this.settings.showMarkers = e.target.checked;
                    this.saveSettings();
                    this.updateMarkers();
                });

                // Marker size sync
                this.markerSizeRange.addEventListener('input', (e) => {
                    this.settings.markerSize = parseInt(e.target.value);
                    this.markerSizeNumber.value = e.target.value;
                    this.saveSettings();
                    this.updateMarkers();
                });

                this.markerSizeNumber.addEventListener('input', (e) => {
                    const value = Math.min(32, Math.max(4, parseInt(e.target.value) || 4));
                    this.settings.markerSize = value;
                    this.markerSizeRange.value = value;
                    e.target.value = value;
                    this.saveSettings();
                    this.updateMarkers();
                });

                // Grid emphasis
                this.emphasizeGridCheckbox.addEventListener('change', (e) => {
                    this.settings.emphasizeGrid = e.target.checked;
                    this.saveSettings();
                    this.drawGrid();
                });

                // Emphasize interval sync
                this.emphasizeIntervalRange.addEventListener('input', (e) => {
                    this.settings.emphasizeInterval = parseInt(e.target.value);
                    this.emphasizeIntervalNumber.value = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                });

                this.emphasizeIntervalNumber.addEventListener('input', (e) => {
                    const value = Math.min(10, Math.max(2, parseInt(e.target.value) || 2));
                    this.settings.emphasizeInterval = value;
                    this.emphasizeIntervalRange.value = value;
                    e.target.value = value;
                    this.saveSettings();
                    this.drawGrid();
                });

                // Emphasize strength sync
                this.emphasizeStrengthRange.addEventListener('input', (e) => {
                    this.settings.emphasizeStrength = parseInt(e.target.value);
                    this.emphasizeStrengthNumber.value = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                });

                this.emphasizeStrengthNumber.addEventListener('input', (e) => {
                    const value = Math.min(5, Math.max(1, parseInt(e.target.value) || 1));
                    this.settings.emphasizeStrength = value;
                    this.emphasizeStrengthRange.value = value;
                    e.target.value = value;
                    this.saveSettings();
                    this.drawGrid();
                });

                // Grid rotation sync
                this.gridRotationRange.addEventListener('input', (e) => {
                    this.settings.gridRotation = parseInt(e.target.value);
                    this.gridRotationNumber.value = e.target.value;
                    this.saveSettings();
                    this.drawGrid();
                });

                this.gridRotationNumber.addEventListener('input', (e) => {
                    const value = Math.min(180, Math.max(0, parseInt(e.target.value) || 0));
                    this.settings.gridRotation = value;
                    this.gridRotationRange.value = value;
                    e.target.value = value;
                    this.saveSettings();
                    this.drawGrid();
                });

                // Reset button
                this.resetButton.addEventListener('click', () => {
                    if (confirm(this.getText('resetConfirm'))) {
                        this.resetSettings();
                    }
                });

                // マウスホイールでスライダー値を変更
                this.setupWheelEvents();

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideSettings();
                    }
                    if (e.key === 'F11') {
                        e.preventDefault();
                        this.toggleFullscreen();
                    }
                });
            }

            setupWheelEvents() {
                // スライダー要素の配列
                const sliders = [
                    { range: this.gridSpacingRange, number: this.gridSpacingNumber, step: 1 },
                    { range: this.gridRotationRange, number: this.gridRotationNumber, step: 1 },
                    { range: this.markerSizeRange, number: this.markerSizeNumber, step: 1 },
                    { range: this.emphasizeIntervalRange, number: this.emphasizeIntervalNumber, step: 1 },
                    { range: this.emphasizeStrengthRange, number: this.emphasizeStrengthNumber, step: 1 }
                ];

                sliders.forEach(slider => {
                    // レンジスライダーにホイールイベントを追加
                    slider.range.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        
                        const currentValue = parseInt(slider.range.value);
                        const min = parseInt(slider.range.min);
                        const max = parseInt(slider.range.max);
                        const step = slider.step;
                        
                        // ホイールの方向に応じて値を増減
                        let newValue = currentValue + (e.deltaY > 0 ? -step : step);
                        
                        // 範囲内に制限
                        newValue = Math.max(min, Math.min(max, newValue));
                        
                        // 値を更新
                        slider.range.value = newValue;
                        slider.number.value = newValue;
                        
                        // input イベントを発火して変更を適用
                        const inputEvent = new Event('input', { bubbles: true });
                        slider.range.dispatchEvent(inputEvent);
                    });

                    // ナンバー入力にもホイールイベントを追加
                    slider.number.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        
                        const currentValue = parseInt(slider.number.value);
                        const min = parseInt(slider.range.min);
                        const max = parseInt(slider.range.max);
                        const step = slider.step;
                        
                        // ホイールの方向に応じて値を増減
                        let newValue = currentValue + (e.deltaY > 0 ? -step : step);
                        
                        // 範囲内に制限
                        newValue = Math.max(min, Math.min(max, newValue));
                        
                        // 値を更新
                        slider.number.value = newValue;
                        slider.range.value = newValue;
                        
                        // input イベントを発火して変更を適用
                        const inputEvent = new Event('input', { bubbles: true });
                        slider.number.dispatchEvent(inputEvent);
                    });
                });
            }

            resizeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = this.canvas.getBoundingClientRect();
                
                // キャンバスの実際のサイズを設定
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                
                // CSS サイズを設定
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                
                // コンテキストを再取得してスケール設定
                this.ctx = this.canvas.getContext('2d');
                this.ctx.scale(dpr, dpr);
            }

            drawGrid() {
                const rect = this.canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                this.ctx.clearRect(0, 0, width, height);
                
                const spacing = this.settings.spacing;
                const emphasize = this.settings.emphasizeGrid;
                const emphasizeInterval = this.settings.emphasizeInterval;
                const emphasizeStrength = this.settings.emphasizeStrength;
                const rotation = this.settings.gridRotation;

                // 回転を適用
                this.ctx.save();
                this.ctx.translate(width / 2, height / 2);
                this.ctx.rotate(rotation * Math.PI / 180);
                this.ctx.translate(-width / 2, -height / 2);

                if (this.settings.gridType === 'lines') {
                    this.drawLines(width, height, spacing, emphasize, emphasizeInterval, emphasizeStrength);
                } else {
                    this.drawDots(width, height, spacing, emphasize, emphasizeInterval, emphasizeStrength);
                }

                this.ctx.restore();
            }

            drawLines(width, height, spacing, emphasize, emphasizeInterval, emphasizeStrength) {
                this.ctx.strokeStyle = this.settings.gridColor;
                
                // キャンバスの中央を原点とする
                const centerX = width / 2;
                const centerY = height / 2;
                
                // 回転を考慮して描画範囲を拡張
                const diagonal = Math.sqrt(width * width + height * height);
                const extent = Math.ceil(diagonal / spacing);
                
                // 垂直線を描画
                for (let i = -extent; i <= extent; i++) {
                    const x = centerX + i * spacing;
                    const isEmphasized = emphasize && Math.abs(i) % emphasizeInterval === 0;
                    this.ctx.lineWidth = isEmphasized ? emphasizeStrength : 1;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, -diagonal);
                    this.ctx.lineTo(x, diagonal);
                    this.ctx.stroke();
                }
                
                // 水平線を描画
                for (let i = -extent; i <= extent; i++) {
                    const y = centerY + i * spacing;
                    const isEmphasized = emphasize && Math.abs(i) % emphasizeInterval === 0;
                    this.ctx.lineWidth = isEmphasized ? emphasizeStrength : 1;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(-diagonal, y);
                    this.ctx.lineTo(diagonal, y);
                    this.ctx.stroke();
                }
            }

            drawDots(width, height, spacing, emphasize, emphasizeInterval, emphasizeStrength) {
                this.ctx.fillStyle = this.settings.gridColor;
                
                // キャンバスの中央を原点とする
                const centerX = width / 2;
                const centerY = height / 2;
                
                // 回転を考慮して描画範囲を拡張
                const diagonal = Math.sqrt(width * width + height * height);
                const extent = Math.ceil(diagonal / spacing);
                
                // 中央から放射状にドットを描画
                for (let i = -extent; i <= extent; i++) {
                    for (let j = -extent; j <= extent; j++) {
                        const x = centerX + i * spacing;
                        const y = centerY + j * spacing;
                        
                        const isEmphasizedX = emphasize && Math.abs(i) % emphasizeInterval === 0;
                        const isEmphasizedY = emphasize && Math.abs(j) % emphasizeInterval === 0;
                        const isEmphasized = isEmphasizedX || isEmphasizedY;
                        
                        const dotSize = isEmphasized ? emphasizeStrength : 1;
                        
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, dotSize, 0, 2 * Math.PI);
                        this.ctx.fill();
                    }
                }
            }

            updateMarkers() {
                this.markersContainer.innerHTML = '';
                
                if (!this.settings.showMarkers) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                const spacing = this.settings.spacing;
                const markerSize = this.settings.markerSize;
                
                // ページの中央点を計算（グリッドの原点と一致）
                const centerX = width / 2;
                const centerY = height / 2;
                
                // 中央目印を原点（キャンバス中央）に描画
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = (centerX - markerSize / 2) + 'px';
                marker.style.top = (centerY - markerSize / 2) + 'px';
                marker.style.width = markerSize + 'px';
                marker.style.height = markerSize + 'px';
                marker.style.backgroundColor = this.settings.markerColor;
                this.markersContainer.appendChild(marker);
            }

            showSettings() {
                this.settingsPopup.classList.add('show');
                // ウィンドウ表示後に位置を調整
                setTimeout(() => this.adjustSettingsPopupPosition(), 10);
                // 表示時に最新の言語でテキストを更新
                this.updateSettingsPopupTexts();
            }

            hideSettings() {
                this.settingsPopup.classList.remove('show');
            }

            toggleSettings() {
                if (this.settingsPopup.classList.contains('show')) {
                    this.hideSettings();
                } else {
                    this.showSettings();
                }
            }

            async toggleFullscreen() {
                try {
                    if (!document.fullscreenElement) {
                        await document.documentElement.requestFullscreen();
                        this.fullscreenButton.textContent = this.getText('fullscreenExit');
                    } else {
                        await document.exitFullscreen();
                        this.fullscreenButton.textContent = this.getText('fullscreenButton');
                    }
                    
                    // 設定ボタンの位置を動的に調整
                    this.adjustSettingsButtonPosition();
                    
                    // 全画面切替後に描画を更新（複数回実行で確実に）
                    setTimeout(() => this.handleResize(), 100);
                    setTimeout(() => this.handleResize(), 300);
                } catch (err) {
                    console.error('Fullscreen error:', err);
                }
            }

            adjustSettingsButtonPosition() {
                // 全画面ボタンの幅を取得
                const fullscreenButtonRect = this.fullscreenButton.getBoundingClientRect();
                const fullscreenButtonWidth = fullscreenButtonRect.width;
                
                // 設定ボタンの位置を調整（全画面ボタンの幅 + マージン20px + 元の右端位置20px）
                const settingsButtonRight = fullscreenButtonWidth + 40;
                this.settingsButton.style.right = settingsButtonRight + 'px';
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GridApp();
        });
    </script>
</body>
</html>
